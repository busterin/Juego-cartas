<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Duelo en 3 â€” Prueba de cartas</title>
  <style>
    :root{
      --bg1:#0b0f1e; --bg2:#151b36; --ink:#eaf2ff; --muted:#a5b3cc;
      --accent:#69f0ff; --accent-2:#7b5cff; --good:#7bff9a; --bad:#ff6b88; --warn:#ffd76b;
      --panel:rgba(255,255,255,.06); --panel-br:rgba(255,255,255,.14);
      --card:#111833; --drop:#223058; --glow:0 10px 30px rgba(0,0,0,.45), inset 0 0 40px rgba(255,255,255,.035);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 0%, #1a2458 0, transparent 60%),
        radial-gradient(900px 600px at 80% 100%, #141e46 0, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }
    #game{
      min-height:100svh; display:flex; flex-direction:column; gap:8px;
      padding:12px 12px calc(16px + env(safe-area-inset-bottom));
      max-width:560px; margin-inline:auto;
    }

    /* HUD */
    .hud{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--panel-br); border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--glow);
    }
    .hud .logo{
      margin:0; font-size:clamp(16px, 4.6vw, 22px); letter-spacing:.4px;
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      filter: drop-shadow(0 0 8px rgba(0,255,255,.25));
      font-weight:800;
    }
    .score{
      display:flex; align-items:center; gap:10px; font-weight:700;
      font-variant-numeric: tabular-nums;
    }
    .tag{ color:var(--muted); font-weight:600; font-size:.9rem; }
    .pill{
      border:1px solid var(--panel-br); background:var(--panel);
      padding:4px 8px; border-radius:10px;
    }
    .btn{ border:1px solid var(--panel-br); background:var(--panel);
      padding:8px 10px; border-radius:10px; color:var(--ink); cursor:pointer;
      box-shadow:var(--glow);
    }
    .btn:active{ transform: translateY(1px); }

    /* Tablero vertical */
    .board{
      display:grid; gap:10px; grid-template-rows: auto 1fr auto;
      min-height:0; /* important for flex container */
    }

    .field{
      display:grid; place-items:center; gap:6px;
    }
    .name{ color:var(--muted); font-weight:600; font-size:.9rem; }

    .slot{
      width:min(92%, 420px); aspect-ratio: 5/3;
      border:2px dashed rgba(105,240,255,.35);
      border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(34,48,88,.35), rgba(34,48,88,.15));
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
      position:relative; overflow:visible;
    }
    .slot.enemy{ border-color: rgba(255,108,132,.35); }
    .slot.highlight{ box-shadow: 0 0 0 3px rgba(105,240,255,.35); transform: scale(1.02); }

    .hint{ color:var(--muted); font-size:.95rem; text-align:center; }

    /* Mano del jugador */
    .hand{
      display:flex; gap:8px; overflow:auto; padding:6px;
      border:1px solid var(--panel-br); border-radius:12px; background:rgba(255,255,255,.04);
      scroll-snap-type:x mandatory;
    }
    .hand::-webkit-scrollbar{ height:8px }
    .hand::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.15); border-radius:4px; }

    /* Carta */
    .card{
      position:relative; flex:0 0 auto;
      width: clamp(68px, 18vw, 96px); aspect-ratio: 5/7;
      border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(160deg, #1a2553 0%, #0f1633 60%);
      box-shadow: 0 4px 18px rgba(0,0,0,.55), inset 0 0 24px rgba(255,255,255,.05);
      display:grid; place-items:center; color: #eaf2ff;
      font-weight:900; font-size: clamp(20px, 7vw, 32px);
      text-shadow: 0 2px 1px rgba(0,0,0,.5), 0 0 10px rgba(105,240,255,.4);
      user-select:none; -webkit-user-select:none; touch-action:none;
      scroll-snap-align:center;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .card .label{
      position:absolute; bottom:6px; left:6px; right:6px;
      font-size:.7rem; color:var(--muted); font-weight:700; letter-spacing:.3px;
      text-align:right;
      opacity:.9;
    }
    .card:hover{ transform: translateY(-2px); }
    .card.played{ opacity:.85; filter:saturate(1.1) drop-shadow(0 0 12px rgba(105,240,255,.28)); }

    /* Fantasma al arrastrar */
    .ghost{
      position:fixed; z-index:9999; pointer-events:none;
      width: clamp(72px, 20vw, 110px); aspect-ratio: 5/7;
      transform: translate(-50%, -50%) scale(1.06);
      transition: left .15s ease, top .15s ease;
      border-radius:12px; border:1px solid rgba(255,255,255,.5);
      background: linear-gradient(160deg, #27408f 0%, #0f1633 60%);
      box-shadow: 0 8px 30px rgba(0,0,0,.6), 0 0 24px rgba(105,240,255,.45) inset;
      display:grid; place-items:center; color:#fff; font-weight:900;
    }
    .ghost .label{ display:none }

    /* Carta colocada en slot */
    .slot .placed{
      position:absolute; inset:8px; border-radius:10px;
      display:grid; place-items:center; font-weight:900;
      background: linear-gradient(160deg, #20326d 0%, #0e142d 60%);
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 6px 24px rgba(0,0,0,.55), inset 0 0 22px rgba(255,255,255,.06);
      font-size: clamp(26px, 8vw, 38px);
    }
    .slot .placed.rival{
      background: linear-gradient(160deg, #5a1f35 0%, #1c0f1a 60%);
      border-color: rgba(255,108,132,.4);
      text-shadow: 0 0 12px rgba(255,108,132,.5);
    }

    /* Mensajes flotantes */
    .toast{
      position:fixed; left:50%; top:18%;
      transform:translateX(-50%); z-index:50;
      background: rgba(0,0,0,.4); border:1px solid var(--panel-br);
      padding:10px 14px; border-radius:12px; backdrop-filter: blur(6px);
      font-weight:700;
      animation: slideDown .38s ease both;
    }
    @keyframes slideDown{
      from{transform:translate(-50%,-6px); opacity:0}
      to{transform:translate(-50%,0); opacity:1}
    }

    /* Overlays */
    .overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(5,8,18,.65), rgba(5,8,18,.75));
      opacity:0; pointer-events:none; transition: opacity .2s ease;
      z-index:100;
    }
    .overlay.visible{ opacity:1; pointer-events:auto; }
    .panel{
      width:min(92%, 440px); background: rgba(255,255,255,.06);
      border:1px solid var(--panel-br); padding:18px; border-radius:16px; box-shadow:var(--glow);
      text-align:center;
    }
    .panel h2{ margin-top:0 }
    .row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

    @media (min-width:480px){
      .slot{ aspect-ratio: 7/3; }
    }
  </style>
</head>
<body>
  <main id="game" aria-label="Duelo de cartas a 3 puntos">
    <header class="hud">
      <h1 class="logo">Duelo en 3</h1>
      <div class="score" aria-live="polite">
        <span class="pill">Primero a 3</span>
        <span>ðŸ‘¤ <strong id="pScore">0</strong></span>
        <span>â€¢</span>
        <span>ðŸ¤– <strong id="eScore">0</strong></span>
      </div>
      <button id="resetBtn" class="btn" aria-label="Reiniciar">â†º</button>
    </header>

    <section class="board" aria-label="Tablero">
      <!-- Campo rival -->
      <div class="field">
        <div id="enemySlot" class="slot enemy" aria-label="Zona del rival"></div>
        <div class="name">Rival</div>
      </div>

      <!-- Centro / zona de drop -->
      <div class="field">
        <div id="playerDrop" class="slot" aria-label="Suelta aquÃ­ tu carta">
          <span class="hint">Arrastra una carta y suÃ©ltala aquÃ­</span>
        </div>
      </div>

      <!-- Mano del jugador -->
      <div class="field">
        <div class="name">Tu mano (elige y arrastra)</div>
        <div id="hand" class="hand" aria-label="Tu mano" role="list"></div>
      </div>
    </section>
  </main>

  <!-- Overlays -->
  <div id="startOverlay" class="overlay visible" role="dialog" aria-labelledby="startTitle">
    <div class="panel">
      <h2 id="startTitle">Duelo en 3</h2>
      <p class="tag">Arrastra una carta al centro. La carta de mayor valor gana el punto.</p>
      <div class="row">
        <button id="startBtn" class="btn">Jugar â–¶</button>
        <button id="howBtn" class="btn">Â¿CÃ³mo se juega?</button>
      </div>
      <details id="how" style="margin-top:8px; color:var(--muted)">
        <summary>Reglas y controles</summary>
        <ul style="text-align:left; line-height:1.5">
          <li>Ambos jugadores juegan una carta por ronda.</li>
          <li>La carta de mayor nÃºmero elimina a la otra y otorga 1 punto.</li>
          <li>En empate, nadie puntÃºa.</li>
          <li>El primero en llegar a 3 puntos gana la partida.</li>
          <li>Arrastra una carta de tu mano al centro (o tÃ³cala y mantenla unos ms si prefieres arrastrar).</li>
        </ul>
      </details>
    </div>
  </div>

  <div id="endOverlay" class="overlay" role="dialog" aria-labelledby="endTitle" aria-live="polite">
    <div class="panel">
      <h2 id="endTitle">Resultado</h2>
      <p id="endLine" style="font-size:1.1rem; margin:.5rem 0 1rem 0;"></p>
      <div class="row">
        <button id="againBtn" class="btn">Jugar de nuevo</button>
        <button id="menuBtn" class="btn">MenÃº</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      // ---------- Utilidades ----------
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const randInt = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
      const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

      // ---------- Estado ----------
      const TARGET = 3;
      const pScoreEl = $('#pScore');
      const eScoreEl = $('#eScore');
      const handEl = $('#hand');
      const dropEl = $('#playerDrop');
      const eSlot = $('#enemySlot');

      const startOverlay = $('#startOverlay');
      const endOverlay = $('#endOverlay');
      const endTitle = $('#endTitle');
      const endLine = $('#endLine');

      let state = {
        resolving:false,
        pScore:0,
        eScore:0,
        pDeck:[],
        eDeck:[],
        pHand:[],
        eHand:[]
      };

      function makeDeck(){
        const d=[];
        for(let r=0;r<2;r++){
          for(let n=1;n<=10;n++) d.push(n);
        }
        // Fisherâ€“Yates
        for(let i=d.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [d[i],d[j]]=[d[j],d[i]];
        }
        return d;
      }

      function updateScore(){
        pScoreEl.textContent = state.pScore;
        eScoreEl.textContent = state.eScore;
      }

      function toast(msg, color=''){
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        if(color) t.style.borderColor = color;
        document.body.appendChild(t);
        setTimeout(()=>{ t.style.opacity='0'; }, 1200);
        setTimeout(()=> t.remove(), 1600);
      }

      // ---------- Mano / cartas ----------
      function createCardEl(value, index){
        const el = document.createElement('div');
        el.className = 'card';
        el.setAttribute('role','listitem');
        el.setAttribute('aria-label', `Carta ${value}`);
        el.dataset.value = String(value);
        el.dataset.index = String(index);
        el.innerHTML = `<div class="num">${value}</div><div class="label">Arrastra</div>`;
        attachDragHandlers(el);
        return el;
      }

      function drawToHand(){
        while(state.pHand.length < 5 && state.pDeck.length){
          state.pHand.push(state.pDeck.pop());
        }
        while(state.eHand.length < 5 && state.eDeck.length){
          state.eHand.push(state.eDeck.pop());
        }
      }

      function renderHand(){
        handEl.innerHTML = '';
        state.pHand.forEach((v, i) => handEl.appendChild(createCardEl(v, i)));
      }

      // ---------- Drag & Drop ----------
      let ghost = null, startRect = null, dragging = null;

      function attachDragHandlers(cardEl){
        cardEl.addEventListener('pointerdown', onDown, {passive:false});
        // Accesibilidad: clic rÃ¡pido como alternativa (jugar sin arrastrar)
        cardEl.addEventListener('click', (e) => {
          // Evita clic inmediatamente despuÃ©s de soltar drag
          if (state.resolving || dragging) return;
          // Simula drop directo
          playFromHand(parseInt(cardEl.dataset.index,10));
        });
      }

      function onDown(e){
        if (state.resolving) return;
        const el = e.currentTarget;
        dragging = el;
        el.setPointerCapture(e.pointerId);
        startRect = el.getBoundingClientRect();
        ghost = document.createElement('div');
        ghost.className = 'ghost';
        ghost.innerHTML = `<div class="num">${el.dataset.value}</div>`;
        document.body.appendChild(ghost);
        moveGhost(e.clientX, e.clientY);
        dropEl.classList.add('highlight');

        const move = (ev)=> moveGhost(ev.clientX, ev.clientY);
        const up = (ev)=>{
          el.releasePointerCapture(e.pointerId);
          window.removeEventListener('pointermove', move);
          window.removeEventListener('pointerup', up, true);
          const over = isOver(dropEl, ev.clientX, ev.clientY);
          dropEl.classList.remove('highlight');
          if (over){
            // animar a centro de drop
            const c = centerOf(dropEl);
            ghost.style.left = c.x+'px';
            ghost.style.top  = c.y+'px';
            setTimeout(()=> {
              playFromHand(parseInt(el.dataset.index,10));
              removeGhost();
            }, 140);
          } else {
            // regresar
            ghost.style.left = (startRect.left + startRect.width/2)+'px';
            ghost.style.top  = (startRect.top + startRect.height/2)+'px';
            setTimeout(()=> removeGhost(), 130);
          }
          dragging = null;
        };
        window.addEventListener('pointermove', move, {passive:false});
        window.addEventListener('pointerup', up, {passive:false, capture:true});
        e.preventDefault();
      }

      function moveGhost(x,y){
        if(!ghost) return;
        ghost.style.left = x+'px';
        ghost.style.top  = y+'px';
      }
      function removeGhost(){ ghost?.remove(); ghost=null; }

      function isOver(target, x, y){
        const r = target.getBoundingClientRect();
        return x>=r.left && x<=r.right && y>=r.top && y<=r.bottom;
      }
      function centerOf(target){
        const r = target.getBoundingClientRect();
        return { x: r.left + r.width/2, y: r.top + r.height/2 };
      }

      // ---------- LÃ³gica de ronda ----------
      function placeCardInSlot(slotEl, value, who='player'){
        slotEl.innerHTML = '';
        const el = document.createElement('div');
        el.className = 'placed' + (who==='enemy' ? ' rival' : '');
        el.textContent = value;
        slotEl.appendChild(el);
        return el;
      }

      function clearSlots(){
        dropEl.innerHTML = `<span class="hint">Arrastra una carta y suÃ©ltala aquÃ­</span>`;
        eSlot.innerHTML = '';
      }

      function chooseEnemyCard(pValue){
        // IA simple: la menor carta que gana a la tuya; si no, su carta mÃ¡s baja.
        const sorted = [...state.eHand].sort((a,b)=>a-b);
        let choice = sorted.find(v => v > pValue);
        if (!choice) choice = sorted[0];
        const idx = state.eHand.indexOf(choice);
        return { value: choice, index: idx };
      }

      function resolveRound(pValue, eValue){
        if (pValue > eValue){
          state.pScore++;
          updateScore();
          toast(`Â¡Ganas la ronda! +1`, 'rgba(123,255,154,.8)');
        } else if (eValue > pValue){
          state.eScore++;
          updateScore();
          toast(`El rival gana la ronda`, 'rgba(255,108,132,.8)');
        } else {
          toast(`Empate`, 'rgba(255,215,107,.8)');
        }
      }

      function checkEnd(){
        if (state.pScore >= TARGET || state.eScore >= TARGET){
          const win = state.pScore > state.eScore;
          endTitle.textContent = win ? 'Â¡Victoria!' : 'Derrota';
          endLine.textContent = `Marcador final â€” TÃº ${state.pScore} : ${state.eScore} Rival`;
          endOverlay.classList.add('visible');
          return true;
        }
        return false;
      }

      function playFromHand(handIndex){
        if (state.resolving) return;
        if (handIndex<0 || handIndex>=state.pHand.length) return;
        state.resolving = true;

        const pValue = state.pHand.splice(handIndex,1)[0];
        renderHand();
        const pPlaced = placeCardInSlot(dropEl, pValue, 'player');

        // Rival juega con pequeÃ±a pausa
        setTimeout(()=>{
          const {value:eValue, index:eIdx} = chooseEnemyCard(pValue);
          state.eHand.splice(eIdx,1);
          const ePlaced = placeCardInSlot(eSlot, eValue, 'enemy');

          // Resolver, actualizar, reponer manos
          setTimeout(()=>{
            resolveRound(pValue, eValue);
            if (checkEnd()) return;

            drawToHand();
            renderHand();

            // Siguiente ronda
            setTimeout(()=>{
              clearSlots();
              state.resolving = false;
            }, 650);
          }, 550);
        }, 400);
      }

      // ---------- Ciclo de vida ----------
      function newGame(){
        state.pScore=0; state.eScore=0; updateScore();
        state.pDeck = makeDeck(); state.eDeck = makeDeck();
        state.pHand=[]; state.eHand=[];
        clearSlots();
        drawToHand();
        renderHand();
        state.resolving=false;
      }

      // ---------- Controles UI ----------
      $('#resetBtn').addEventListener('click', () => {
        newGame();
        toast('Partida reiniciada');
      });

      $('#startBtn').addEventListener('click', () => {
        startOverlay.classList.remove('visible');
        newGame();
      });
      $('#howBtn').addEventListener('click', () => {
        const d = $('#how'); d.open = !d.open;
      });
      $('#againBtn').addEventListener('click', () => {
        endOverlay.classList.remove('visible');
        newGame();
      });
      $('#menuBtn').addEventListener('click', () => {
        endOverlay.classList.remove('visible');
        startOverlay.classList.add('visible');
      });

      // âœ… Bloquea solo clics FUERA del panel cuando el overlay estÃ¡ visible
const blockWhenOverlay = (e) => {
  const anyVisible = startOverlay.classList.contains('visible') || endOverlay.classList.contains('visible');
  if (!anyVisible) return;
  // Permitir interacciÃ³n con los controles del overlay (panel y su contenido)
  if (e.target.closest('.overlay .panel')) return;
  // Bloquear clics en el resto de la pÃ¡gina
  e.stopPropagation();
  e.preventDefault();
};
document.addEventListener('pointerdown', blockWhenOverlay, {capture:true});
document.addEventListener('click', blockWhenOverlay, {capture:true});
      // Ajustes al cambiar tamaÃ±o (solo para resaltar hitbox)
      const ro = new ResizeObserver(()=>{ /* layout responsive sin JS extra */ });
      ro.observe(document.body);
    })();
  </script>
</body>
</html>
